{% extends "base.html" %}

{% block title %}Dashboard - Earnings Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h2>Dashboard</h2>
        <div class="dashboard-controls">
            <div class="worker-filter">
                <label for="worker-select">Filter by Worker:</label>
                <select id="worker-select" class="form-select" onchange="filterByWorker()">
                    <option value="all" {% if selected_worker == 'all' %}selected{% endif %}>All Workers</option>
                    {% for worker in workers %}
                    <option value="{{ worker.name }}" {% if selected_worker == worker.name %}selected{% endif %}>
                        {{ worker.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="period-filters">
                <button class="btn btn-sm" onclick="updateCharts('daily')">Daily</button>
                <button class="btn btn-sm" onclick="updateCharts('weekly')">Weekly</button>
                <button class="btn btn-sm" onclick="updateCharts('monthly')">Monthly</button>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Revenue</h3>
            <p class="stat-value">{{ settings.currency_symbol }}{{ "%.2f"|format(total_revenue) }}</p>
            {% if revenue_change != 0 %}
            <small class="trend-indicator {% if revenue_change > 0 %}trend-up{% else %}trend-down{% endif %}">
                {% if revenue_change > 0 %}‚Üë{% else %}‚Üì{% endif %} {{ "%.1f"|format(revenue_change_percent_abs) }}%
            </small>
            {% endif %}
        </div>
        <div class="stat-card">
            <h3>Total Hours</h3>
            <p class="stat-value">{{ "%.1f"|format(total_hours) }}</p>
        </div>
        <div class="stat-card">
            <h3>Entries</h3>
            <p class="stat-value">{{ entry_count }}</p>
        </div>
        <div class="stat-card">
            <h3>Avg Daily Revenue</h3>
            <p class="stat-value">{{ settings.currency_symbol }}{{ "%.2f"|format(avg_daily_revenue) }}</p>
        </div>
        <div class="stat-card">
            <h3>Avg Hours/Day</h3>
            <p class="stat-value">{{ "%.1f"|format(avg_hours_per_day) }}</p>
        </div>
        <div class="stat-card">
            <h3>Take-Home</h3>
            <p class="stat-value">{{ settings.currency_symbol }}{{ "%.2f"|format(take_home_amount) }}</p>
            <small>({{ settings.take_home_percent }}%)</small>
        </div>
        <div class="stat-card">
            <h3>Avg Daily Take-Home</h3>
            <p class="stat-value">{{ settings.currency_symbol }}{{ "%.2f"|format(avg_daily_take_home) }}</p>
        </div>
        <div class="stat-card">
            <h3>Monthly Take-Home</h3>
            <p class="stat-value">{{ settings.currency_symbol }}{{ "%.2f"|format(monthly_take_home_amount) }}</p>
            <small>Current month</small>
        </div>
        {% if target_days_per_month > 0 %}
        <div class="stat-card {% if target_days_status == 'on_target' or target_days_status == 'ahead' %}stat-card-highlight{% elif target_days_status == 'behind_target' %}stat-card-warning{% endif %}">
            <h3>Days Target Status</h3>
            <p class="stat-value {% if target_days_status == 'on_target' or target_days_status == 'ahead' %}stat-value-success{% elif target_days_status == 'behind_target' %}stat-value-warning{% endif %}">
                {% if target_days_status == 'on_target' %}
                    ‚úì On Target
                {% elif target_days_status == 'ahead' %}
                    ‚Üë Ahead
                {% elif target_days_status == 'behind_target' %}
                    ‚ö†Ô∏è Behind Target
                {% else %}
                    üìä On Track
                {% endif %}
            </p>
            <small>{{ days_worked_this_month }} / {{ target_days_per_month }} days worked</small>
            {% if monthly_take_home_goal > 0 and days_needed_for_goal is not none %}
            <small>{{ days_needed_for_goal }} days needed / {{ days_remaining_in_month }} days remaining</small>
            {% endif %}
        </div>
        {% endif %}
        <div class="stat-card">
            <h3>Avg Hourly Rate</h3>
            <p class="stat-value">{{ settings.currency_symbol }}{{ "%.2f"|format(avg_hourly_rate) }}</p>
        </div>
        {% if best_day %}
        <div class="stat-card stat-card-highlight">
            <h3>Best Day</h3>
            <p class="stat-value">{{ best_day.strftime('%b %d') }}</p>
            <small>{{ settings.currency_symbol }}{{ "%.2f"|format(best_day_revenue) }} / {{ "%.1f"|format(best_day_hours) }}h</small>
        </div>
        {% endif %}
    </div>

    <!-- Goals & Targets Section -->
    {% if (settings.daily_revenue_goal|default(0) > 0) or (settings.monthly_revenue_goal|default(0) > 0) or (settings.monthly_take_home_goal|default(0) > 0) or (settings.profit_quota|default(0) > 0) or (settings.loss_quota|default(0) > 0) %}
    <div class="goals-section">
        <h2>Goals & Targets</h2>
        
        <div class="goals-grid">
            {% if settings.daily_revenue_goal|default(0) > 0 %}
            <div class="goal-card">
                <div class="goal-header">
                    <h3>Daily Revenue Goal</h3>
                    <span class="goal-status {% if daily_goal_progress >= 100 %}goal-met{% elif daily_goal_progress >= 75 %}goal-close{% else %}goal-pending{% endif %}">
                        {% if daily_goal_progress >= 100 %}‚úì Met{% elif daily_goal_progress >= 75 %}‚ö° Close{% else %}üìä In Progress{% endif %}
                    </span>
                </div>
                <div class="goal-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ [daily_goal_progress, 100]|min }}%"></div>
                    </div>
                    <div class="goal-details">
                        <span class="goal-current">{{ settings.currency_symbol }}{{ "%.2f"|format(daily_revenue) }}</span>
                        <span class="goal-target">/ {{ settings.currency_symbol }}{{ "%.2f"|format(settings.daily_revenue_goal|default(0)) }}</span>
                        <span class="goal-percent">{{ "%.1f"|format(daily_goal_progress) }}%</span>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if settings.monthly_revenue_goal|default(0) > 0 %}
            <div class="goal-card">
                <div class="goal-header">
                    <h3>Monthly Revenue Goal</h3>
                    <span class="goal-status {% if monthly_goal_progress >= 100 %}goal-met{% elif monthly_goal_progress >= 75 %}goal-close{% else %}goal-pending{% endif %}">
                        {% if monthly_goal_progress >= 100 %}‚úì Met{% elif monthly_goal_progress >= 75 %}‚ö° Close{% else %}üìä In Progress{% endif %}
                    </span>
                </div>
                <div class="goal-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ [monthly_goal_progress, 100]|min }}%"></div>
                    </div>
                    <div class="goal-details">
                        <span class="goal-current">{{ settings.currency_symbol }}{{ "%.2f"|format(monthly_revenue) }}</span>
                        <span class="goal-target">/ {{ settings.currency_symbol }}{{ "%.2f"|format(settings.monthly_revenue_goal|default(0)) }}</span>
                        <span class="goal-percent">{{ "%.1f"|format(monthly_goal_progress) }}%</span>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if settings.monthly_take_home_goal|default(0) > 0 %}
            <div class="goal-card">
                <div class="goal-header">
                    <h3>Monthly Take-Home Goal</h3>
                    <span class="goal-status {% if monthly_take_home_goal_progress >= 100 %}goal-met{% elif monthly_take_home_goal_progress >= 75 %}goal-close{% else %}goal-pending{% endif %}">
                        {% if monthly_take_home_goal_progress >= 100 %}‚úì Met{% elif monthly_take_home_goal_progress >= 75 %}‚ö° Close{% else %}üìä In Progress{% endif %}
                    </span>
                </div>
                <div class="goal-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ [monthly_take_home_goal_progress, 100]|min }}%"></div>
                    </div>
                    <div class="goal-details">
                        <span class="goal-current">{{ settings.currency_symbol }}{{ "%.2f"|format(monthly_take_home_amount) }}</span>
                        <span class="goal-target">/ {{ settings.currency_symbol }}{{ "%.2f"|format(settings.monthly_take_home_goal|default(0)) }}</span>
                        <span class="goal-percent">{{ "%.1f"|format(monthly_take_home_goal_progress) }}%</span>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if settings.monthly_take_home_goal|default(0) > 0 %}
            <div class="goal-card">
                <div class="goal-header">
                    <h3>Days Needed for Goal</h3>
                    <span class="goal-status {% if days_needed_for_goal is not none and days_needed_for_goal <= 7 %}goal-met{% elif days_needed_for_goal is not none and days_needed_for_goal <= 14 %}goal-close{% else %}goal-pending{% endif %}">
                        {% if days_needed_for_goal is none %}
                        ‚ö†Ô∏è Not Achievable
                        {% elif remaining_take_home_needed <= 0 %}
                        ‚úì Goal Achieved
                        {% elif days_needed_for_goal == 0 %}
                        ‚úì Goal Met
                        {% else %}
                        üìÖ {{ days_needed_for_goal }} Day{{ 's' if days_needed_for_goal > 1 else '' }}
                        {% endif %}
                    </span>
                </div>
                <div class="goal-progress">
                    <div class="goal-details">
                        {% if days_needed_for_goal is none %}
                        <span class="goal-current">Goal cannot be achieved with current average</span>
                        {% elif remaining_take_home_needed <= 0 %}
                        <span class="goal-current">Monthly goal already achieved! üéâ</span>
                        {% else %}
                        <span class="goal-current">{{ settings.currency_symbol }}{{ "%.2f"|format(remaining_take_home_needed) }} remaining</span>
                        <span class="goal-target">@ {{ settings.currency_symbol }}{{ "%.2f"|format(avg_daily_take_home_this_month) }}/day</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if settings.profit_quota > 0 %}
            <div class="goal-card">
                <div class="goal-header">
                    <h3>Profit Quota</h3>
                    <span class="goal-status {% if profit_quota_met %}goal-met{% else %}goal-pending{% endif %}">
                        {% if profit_quota_met %}‚úì Quota Met{% else %}üìä Below Quota{% endif %}
                    </span>
                </div>
                <div class="goal-progress">
                    <div class="quota-display">
                        <span class="quota-current">{{ settings.currency_symbol }}{{ "%.2f"|format(take_home_amount) }}</span>
                        <span class="quota-target">/ {{ settings.currency_symbol }}{{ "%.2f"|format(settings.profit_quota|default(0)) }}</span>
                        {% if settings.profit_quota|default(0) > 0 %}
                        <span class="quota-percent">{{ "%.1f"|format((take_home_amount / (settings.profit_quota|default(0)) * 100) if (settings.profit_quota|default(0)) > 0 else 0) }}%</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if settings.loss_quota|default(0) > 0 and loss_quota_exceeded %}
            <div class="goal-card goal-card-warning">
                <div class="goal-header">
                    <h3>‚ö†Ô∏è Loss Quota Exceeded</h3>
                    <span class="goal-status goal-exceeded">‚ö†Ô∏è Warning</span>
                </div>
                <div class="goal-progress">
                    <div class="quota-display">
                        <span class="quota-current">{{ settings.currency_symbol }}{{ "%.2f"|format(take_home_amount) }}</span>
                        <span class="quota-target">/ -{{ settings.currency_symbol }}{{ "%.2f"|format(settings.loss_quota|default(0)) }}</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="breakdown-section">
        <h3>Revenue Breakdown</h3>
        <div class="breakdown-grid">
            <div class="breakdown-item">
                <span class="breakdown-label">Tax ({{ settings.tax_percent }}%)</span>
                <span class="breakdown-value">{{ settings.currency_symbol }}{{ "%.2f"|format(tax_amount) }}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-label">Reinvest ({{ settings.reinvest_percent }}%)</span>
                <span class="breakdown-value">{{ settings.currency_symbol }}{{ "%.2f"|format(reinvest_amount) }}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-label">Take-Home ({{ settings.take_home_percent }}%)</span>
                <span class="breakdown-value">{{ settings.currency_symbol }}{{ "%.2f"|format(take_home_amount) }}</span>
            </div>
        </div>
    </div>

    <div class="charts-section">
        <div class="chart-container">
            <h3>Revenue Over Time</h3>
            <canvas id="revenueChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Hours Worked</h3>
            <canvas id="hoursChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Revenue vs Hours</h3>
            <canvas id="revenueHoursChart"></canvas>
        </div>
    </div>
    
    {% if worker_stats|length > 0 %}
    <div class="charts-section">
        <div class="chart-container">
            <h3>Revenue by Worker</h3>
            <canvas id="workerRevenueChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Hours by Worker</h3>
            <canvas id="workerHoursChart"></canvas>
        </div>
    </div>
    {% endif %}

    <div class="recent-entries">
        <div class="entries-header">
            <h3>Recent Entries</h3>
            {% if entries.items %}
            <div class="entries-info">
                Showing {{ (entries.page - 1) * entries.per_page + 1 }} - {{ entries.page * entries.per_page if entries.page * entries.per_page <= entries.total else entries.total }} of {{ entries.total }}
            </div>
            {% endif %}
        </div>
        {% if entries.items %}
        <table class="entries-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Hours</th>
                    <th>Revenue</th>
                    <th>Worker</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries.items %}
                <tr>
                    <td>{{ entry.date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ "%.1f"|format(entry.hours) }}</td>
                    <td>{{ settings.currency_symbol }}{{ "%.2f"|format(entry.revenue) }}</td>
                    <td>{{ entry.worker_name or '-' }}</td>
                    <td>
                        <a href="{{ url_for('add_entry', id=entry.id) }}" class="btn-link">Edit</a>
                        <a href="{{ url_for('delete_entry', entry_id=entry.id) }}" class="btn-link btn-danger" onclick="return confirm('Delete this entry?')">Delete</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Pagination -->
        {% if entries.total > 0 %}
        <div class="pagination">
            {% if entries.pages > 1 %}
            <div class="pagination-controls">
                {% if entries.has_prev %}
                <a href="{{ url_for('dashboard', page=entries.prev_num, worker=selected_worker, per_page=per_page) }}" class="btn btn-sm btn-outline">Previous</a>
                {% else %}
                <span class="btn btn-sm btn-outline disabled">Previous</span>
                {% endif %}
                
                <div class="pagination-pages">
                    {% for page_num in entries.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            {% if page_num == entries.page %}
                                <span class="pagination-page active">{{ page_num }}</span>
                            {% else %}
                                <a href="{{ url_for('dashboard', page=page_num, worker=selected_worker, per_page=per_page) }}" class="pagination-page">{{ page_num }}</a>
                            {% endif %}
                        {% else %}
                            <span class="pagination-ellipsis">...</span>
                        {% endif %}
                    {% endfor %}
                </div>
                
                {% if entries.has_next %}
                <a href="{{ url_for('dashboard', page=entries.next_num, worker=selected_worker, per_page=per_page) }}" class="btn btn-sm btn-outline">Next</a>
                {% else %}
                <span class="btn btn-sm btn-outline disabled">Next</span>
                {% endif %}
            </div>
            {% endif %}
            
            <div class="pagination-per-page">
                <label for="per-page-select">Per page:</label>
                <select id="per-page-select" class="form-select" onchange="changePerPage(this.value)" style="width: auto; display: inline-block; margin-left: 0.5rem;">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                </select>
            </div>
        </div>
        {% endif %}
        {% else %}
        <p class="no-entries">No entries yet. <a href="{{ url_for('add_entry') }}">Add your first entry</a></p>
        {% endif %}
    </div>
</div>

<script>
let revenueChart, hoursChart, revenueHoursChart;
let workerRevenueChart, workerHoursChart;
let currentPeriod = 'daily';

function filterByWorker() {
    const worker = document.getElementById('worker-select').value;
    const url = new URL(window.location.href);
    url.searchParams.set('worker', worker);
    url.searchParams.set('page', '1'); // Reset to first page when filtering
    // Update charts immediately without page reload
    updateCharts(currentPeriod);
    // Update URL without reload
    window.history.pushState({}, '', url.toString());
}

function updateCharts(period) {
    currentPeriod = period;
    // Get worker filter from URL parameter first, then fallback to dropdown
    const urlParams = new URLSearchParams(window.location.search);
    const workerFromUrl = urlParams.get('worker');
    const workerSelect = document.getElementById('worker-select');
    const worker = workerFromUrl || (workerSelect ? workerSelect.value : 'all');
    
    // Ensure dropdown matches current filter
    if (workerSelect && workerFromUrl) {
        workerSelect.value = workerFromUrl;
    }
    
    fetch(`/api/chart_data?period=${period}&worker=${encodeURIComponent(worker)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Ensure data has required properties
            if (!data || !data.labels || !data.revenue || !data.hours) {
                console.warn('Invalid chart data received:', data);
                return;
            }
            updateRevenueChart(data);
            updateHoursChart(data);
            updateRevenueHoursChart(data);
        })
        .catch(error => {
            console.error('Error fetching chart data:', error);
        });
}

function updateRevenueChart(data) {
    if (revenueChart) {
        revenueChart.destroy();
    }
    const ctxElement = document.getElementById('revenueChart');
    if (!ctxElement) return;
    if (!data || !data.labels || !Array.isArray(data.labels) || data.labels.length === 0) {
        console.warn('No data available for revenue chart');
        return;
    }
    const ctx = ctxElement.getContext('2d');
    revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Revenue ({{ settings.currency_symbol }})',
                data: data.revenue || [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateHoursChart(data) {
    if (hoursChart) {
        hoursChart.destroy();
    }
    const ctxElement = document.getElementById('hoursChart');
    if (!ctxElement) return;
    if (!data || !data.labels || !Array.isArray(data.labels) || data.labels.length === 0) {
        console.warn('No data available for hours chart');
        return;
    }
    const ctx = ctxElement.getContext('2d');
    hoursChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Hours',
                data: data.hours || [],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + 'h';
                        }
                    }
                }
            }
        }
    });
}

function updateRevenueHoursChart(data) {
    if (revenueHoursChart) {
        revenueHoursChart.destroy();
    }
    const ctxElement = document.getElementById('revenueHoursChart');
    if (!ctxElement) return;
    if (!data || !data.labels || !Array.isArray(data.labels) || data.labels.length === 0) {
        console.warn('No data available for revenue vs hours chart');
        return;
    }
    const ctx = ctxElement.getContext('2d');
    
    revenueHoursChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Revenue ({{ settings.currency_symbol }})',
                data: data.revenue || [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                yAxisID: 'y',
                tension: 0.1
            }, {
                label: 'Hours',
                data: data.hours || [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                yAxisID: 'y1',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                                if (context.datasetIndex === 0) {
                                    label += '{{ settings.currency_symbol }}' + context.parsed.y.toFixed(2);
                                } else {
                                    label += context.parsed.y.toFixed(1) + 'h';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '{{ settings.currency_symbol }}' + value.toFixed(0);
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + 'h';
                        }
                    }
                }
            }
        }
    });
}

// Initialize worker charts
{% if worker_stats|length > 0 %}
function initWorkerCharts() {
    const workerData = {
        labels: [],
        revenue: [],
        hours: []
    };
    
    {% for worker_name, stats in worker_stats.items() %}
    workerData.labels.push('{{ worker_name }}');
    workerData.revenue.push({{ stats.revenue }});
    workerData.hours.push({{ stats.hours }});
    {% endfor %}
    
    // Only render charts if we have data
    if (workerData.labels.length === 0) {
        console.log('No worker data available for charts');
        return;
    }
    
    // Worker Revenue Pie Chart
    const revenueCtx = document.getElementById('workerRevenueChart');
    if (revenueCtx) {
        if (workerRevenueChart) {
            workerRevenueChart.destroy();
        }
        workerRevenueChart = new Chart(revenueCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: workerData.labels,
                datasets: [{
                    data: workerData.revenue,
                    backgroundColor: [
                        'rgba(99, 102, 241, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(139, 92, 246, 0.8)',
                        'rgba(236, 72, 153, 0.8)'
                    ],
                    borderColor: [
                        'rgb(99, 102, 241)',
                        'rgb(16, 185, 129)',
                        'rgb(245, 158, 11)',
                        'rgb(239, 68, 68)',
                        'rgb(139, 92, 246)',
                        'rgb(236, 72, 153)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': {{ settings.currency_symbol }}' + value.toFixed(2) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Worker Hours Bar Chart
    const hoursCtx = document.getElementById('workerHoursChart');
    if (hoursCtx) {
        if (workerHoursChart) {
            workerHoursChart.destroy();
        }
        workerHoursChart = new Chart(hoursCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: workerData.labels,
                datasets: [{
                    label: 'Hours',
                    data: workerData.hours,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgb(54, 162, 235)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + 'h';
                            }
                        }
                    }
                }
            }
        });
    }
}
{% endif %}

// Initialize charts on page load
document.addEventListener('DOMContentLoaded', function() {
    // Get worker filter from URL or dropdown
    const urlParams = new URLSearchParams(window.location.search);
    const workerParam = urlParams.get('worker') || 'all';
    
    // Set dropdown to match URL parameter
    const workerSelect = document.getElementById('worker-select');
    if (workerSelect) {
        workerSelect.value = workerParam;
    }
    
    // Initialize charts with current worker filter
    updateCharts('daily');
    
    // Initialize worker charts if available
    {% if worker_stats|length > 0 %}
    initWorkerCharts();
    {% endif %}
});

function changePerPage(value) {
    const url = new URL(window.location.href);
    const worker = document.getElementById('worker-select')?.value || 'all';
    url.searchParams.set('per_page', value);
    url.searchParams.set('page', '1'); // Reset to first page
    url.searchParams.set('worker', worker); // Preserve worker filter
    window.location.href = url.toString();
}
</script>
{% endblock %}

